<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORRENTGUARD // DEEP_DIVE</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* --- THEME: INDUSTRIAL VOID --- */
            --c-void: #030304;
            --c-panel: #0a0a0c;
            --c-surface: #111114;

            --c-accent-main: #00f0ff;
            /* Cyan */
            --c-accent-warn: #ffae00;
            /* Safety Orange */
            --c-accent-crit: #ff003c;
            /* Kill Red */
            --c-text-dim: #4a4a55;
            --c-text-mid: #888899;
            --c-text-lite: #e0e0e0;

            --border-hard: 1px solid #2a2a30;
            --border-glow: 1px solid rgba(0, 240, 255, 0.3);

            --font-ui: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;

            --scan-line-color: rgba(255, 255, 255, 0.03);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            background-color: var(--c-void);
            color: var(--c-text-lite);
            font-family: var(--font-mono);
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: 50px 1fr 30px;
            /* Subtle CRT Scanline effect */
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }

        /* --- LAYOUT GRID --- */
        .main-stage {
            padding: 10px;
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            grid-template-rows: 60% 1fr;
            gap: 10px;
            height: 100%;
        }

        /* --- COMPONENT: PANEL --- */
        .panel {
            background: var(--c-panel);
            border: var(--border-hard);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            border-top: 2px solid var(--c-text-dim);
            border-left: 2px solid var(--c-text-dim);
            transition: all 0.3s;
        }

        .panel:hover::before {
            border-color: var(--c-accent-main);
            width: 100%;
        }

        .panel-header {
            background: var(--c-surface);
            padding: 8px 12px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--c-text-mid);
            border-bottom: var(--border-hard);
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .panel-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        /* --- TOP HEADER --- */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: var(--border-hard);
            background: var(--c-panel);
        }

        .brand {
            font-family: var(--font-ui);
            font-weight: 700;
            font-size: 20px;
            letter-spacing: -1px;
            color: var(--c-text-lite);
        }

        .brand span {
            color: var(--c-accent-main);
        }

        .sys-status {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: var(--c-text-dim);
        }

        .status-light {
            width: 8px;
            height: 8px;
            background: var(--c-text-dim);
            display: inline-block;
            margin-right: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .status-light.on {
            background: var(--c-accent-main);
            box-shadow: 0 0 8px var(--c-accent-main);
        }

        /* --- DROPZONE (AIRLOCK) --- */
        .airlock {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px dashed var(--c-text-dim);
            transition: 0.2s;
            cursor: pointer;
            text-align: center;
        }

        .airlock:hover {
            border-color: var(--c-accent-main);
            background: rgba(0, 240, 255, 0.02);
            letter-spacing: 1px;
        }

        .airlock-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--c-text-dim);
        }

        /* --- VISUALIZER (THE PIT) --- */
        .visualizer-container {
            grid-column: 2;
            grid-row: 1 / span 2;
            background: radial-gradient(circle at center, #1a1a20 0%, #000 100%);
            perspective: 1000px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-plane {
            width: 600px;
            height: 600px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(20px, 1fr));
            gap: 2px;
            transform: rotateX(45deg) rotateZ(0deg);
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }

        .sector {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
            position: relative;
        }

        .sector:hover {
            background: var(--c-accent-main);
            box-shadow: 0 0 10px var(--c-accent-main);
            z-index: 10;
            transform: translateZ(20px);
        }

        /* States */
        .sector.scanning {
            animation: scanFlash 0.5s infinite;
        }

        .sector.clean {
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--c-accent-main);
        }

        .sector.warn {
            background: rgba(255, 174, 0, 0.4);
            border-color: var(--c-accent-warn);
            transform: translateZ(10px);
        }

        .sector.crit {
            background: var(--c-accent-crit);
            box-shadow: 0 0 15px var(--c-accent-crit);
            transform: translateZ(40px);
            animation: pulseCrit 0.8s infinite alternate;
        }

        @keyframes scanFlash {
            0% {
                opacity: 0.2;
            }

            50% {
                opacity: 1;
                background: #fff;
            }

            100% {
                opacity: 0.2;
            }
        }

        @keyframes pulseCrit {
            from {
                box-shadow: 0 0 5px var(--c-accent-crit);
            }

            to {
                box-shadow: 0 0 25px var(--c-accent-crit);
            }
        }

        /* --- HEX DUMP VIEW --- */
        .hex-view {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--c-text-dim);
            line-height: 1.4;
            opacity: 0.7;
        }

        .hex-highlight {
            color: var(--c-accent-main);
            font-weight: bold;
            background: rgba(0, 240, 255, 0.1);
        }

        .hex-danger {
            color: var(--c-accent-crit);
            font-weight: bold;
        }

        /* --- METRICS & GRAPHS --- */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 60px;
            margin-top: 10px;
        }

        .bar {
            flex: 1;
            background: var(--c-text-dim);
            transition: height 0.2s;
        }

        .bar.active {
            background: var(--c-accent-main);
        }

        /* --- LOGS --- */
        .log-feed {
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .log-item {
            display: flex;
            gap: 10px;
            border-left: 2px solid transparent;
            padding-left: 5px;
        }

        .log-item.info {
            border-color: var(--c-accent-main);
            color: var(--c-text-lite);
        }

        .log-item.warn {
            border-color: var(--c-accent-warn);
            color: var(--c-accent-warn);
        }

        .log-item.err {
            border-color: var(--c-accent-crit);
            color: var(--c-accent-crit);
        }

        .ts {
            opacity: 0.5;
            min-width: 60px;
        }

        /* --- BUTTONS --- */
        .btn-cyber {
            background: transparent;
            border: 1px solid var(--c-accent-main);
            color: var(--c-accent-main);
            padding: 10px;
            font-family: var(--font-mono);
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            font-weight: 700;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }

        .btn-cyber:hover {
            background: var(--c-accent-main);
            color: var(--c-void);
            box-shadow: 0 0 15px var(--c-accent-main);
        }

        .btn-cyber:disabled {
            border-color: var(--c-text-dim);
            color: var(--c-text-dim);
            pointer-events: none;
            box-shadow: none;
        }

        /* --- OVERLAY --- */
        .overlay-report {
            position: absolute;
            inset: 20px;
            background: rgba(3, 3, 4, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--c-text-dim);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .overlay-report.visible {
            opacity: 1;
            pointer-events: all;
        }

        .report-card {
            width: 500px;
            border: 1px solid var(--c-accent-main);
            padding: 40px;
            background: #000;
            box-shadow: 0 0 50px rgba(0, 240, 255, 0.1);
            position: relative;
        }

        .deco-line {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--c-accent-main), transparent);
            margin: 20px 0;
        }

        /* --- UTILS --- */
        .mono-val {
            color: var(--c-accent-main);
            float: right;
        }

        .blink {
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .risk-gauge {
            width: 100%;
            height: 4px;
            background: #222;
            margin-top: 5px;
            position: relative;
        }

        .risk-fill {
            height: 100%;
            width: 0%;
            background: var(--c-accent-main);
            transition: 0.3s;
            box-shadow: 0 0 10px currentColor;
        }
    </style>
</head>

<body>

    <header>
        <div class="brand">TORRENT<span>GUARD</span> <span style="font-size: 10px; opacity: 0.5; margin-left: 10px;">//
                SYSTEM_V.4.0</span></div>
        <div class="sys-status">
            <div><span class="status-light" id="netStat"></span>NET_UPLINK</div>
            <div id="engineStatus"><span class="status-light on" id="engineLight"></span><span
                    id="engineText">ENGINE_IDLE</span></div>
            <div>MEM: <span id="memVal">0</span>%</div>
            <div>UPTIME: <span id="uptime">00:00:00</span></div>
            <div>FPS: <span id="fpsCounter">--</span></div>
        </div>
    </header>

    <div class="main-stage">

        <div class="panel" style="grid-row: 1;">
            <div class="panel-header">01 // INTAKE_PROTOCOL</div>
            <div class="panel-content" style="padding: 0;">
                <div id="dropZone" class="airlock" onclick="document.getElementById('fileInput').click()">
                    <div class="airlock-icon">⏏</div>
                    <div>INITIATE UPLOAD</div>
                    <div style="font-size: 10px; color: var(--c-text-dim); margin-top: 5px;">[DRAG OBJECT HERE]
                    </div>
                    <input type="file" id="fileInput" accept=".torrent" style="display: none;">
                </div>
            </div>
        </div>

        <div class="panel" style="grid-row: 2;">
            <div class="panel-header">02 // OBJECT_METADATA</div>
            <div class="panel-content">
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 10px; color: var(--c-text-dim);">FILE_NAME</div>
                    <div id="metaName"
                        style="color: var(--c-text-lite); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        --</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 10px; color: var(--c-text-dim);">SIZE_ON_DISK</div>
                    <div id="metaSize">--</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 10px; color: var(--c-accent-main);">HASH_ID</div>
                    <div id="metaHash" style="font-size: 10px; color: var(--c-accent-main);">--</div>
                </div>

                <button id="btnScan" class="btn-cyber" disabled onclick="startScan()">EXECUTE SCAN</button>
            </div>
        </div>

        <div class="panel visualizer-container">
            <div id="gridPlane" class="grid-plane">
            </div>
            <div
                style="position: absolute; bottom: 20px; left: 20px; font-size: 12px; font-weight: bold; color: var(--c-accent-main);">
                SECTOR_VISUALIZATION <span class="blink">_</span>
            </div>
        </div>

        <div class="panel" style="grid-row: 1;">
            <div class="panel-header">03 // SIGNAL_ANALYSIS</div>
            <div class="panel-content">
                <div style="height: 60px; border-bottom: 1px solid #222; margin-bottom: 10px; position: relative;">
                    <canvas id="noiseCanvas"></canvas>
                    <div style="position: absolute; top:0; left:0; font-size: 9px; color: var(--c-text-dim);">
                        ENTROPY_WAVEFORM</div>
                </div>

                <div style="font-size: 10px; margin-bottom: 5px; display: flex; justify-content: space-between;">
                    <span>THREAT_PROBABILITY</span>
                    <span id="riskNum">0.0%</span>
                </div>
                <div class="risk-gauge">
                    <div id="riskFill" class="risk-fill"></div>
                </div>

                <div style="margin-top: 20px;">
                    <div style="font-size: 10px; margin-bottom: 5px;">BUFFER_DUMP</div>
                    <div id="hexDump" class="hex-view">
                        00 00 00 00 00 00 00 00<br>
                        00 00 00 00 00 00 00 00<br>
                        00 00 00 00 00 00 00 00<br>
                        00 00 00 00 00 00 00 00
                    </div>
                </div>
            </div>
        </div>

        <div class="panel" style="grid-row: 2;">
            <div class="panel-header">04 // SYSTEM_LOG</div>
            <div class="panel-content" id="logConsole">
                <div class="log-feed" id="logFeed">
                    <div class="log-item info"><span class="ts">00:00:00</span><span>SYS_INIT... OK</span></div>
                </div>
            </div>
        </div>

    </div>

    <div
        style="display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-size: 10px; color: #444; border-top: var(--border-hard);">
        <div>UI_RENDER: GPU_ACCELERATED</div>
        <div>LATENCY: <span id="ping">12</span>ms</div>
    </div>

    <div id="resultOverlay" class="overlay-report">
        <div class="report-card">
            <h1 id="reportTitle" style="margin: 0; font-size: 32px; color: var(--c-text-lite);">SCAN_COMPLETE</h1>
            <div class="deco-line"></div>
            <p id="reportSub" style="color: var(--c-text-mid); line-height: 1.6;">Analysis finished.</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 30px;">
                <button class="btn-cyber" onclick="location.reload()">PURGE_DATA</button>
                <button class="btn-cyber" onclick="saveLog()">SAVE_LOG</button>
                <button class="btn-cyber"
                    onclick="document.getElementById('resultOverlay').classList.remove('visible')">REVIEW_DATA</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const socket = io(API_URL);

        // --- UI State ---
        let currentTorrentId = null;
        let totalPieces = 0;
        let isScanning = false;
        let maxRisk = 0;

        // --- Visualizer Setup ---
        const gridPlane = document.getElementById('gridPlane');
        const hexDump = document.getElementById('hexDump');
        const logFeed = document.getElementById('logFeed');

        // --- Canvas Noise Effect (Fake Waveform) ---
        const canvas = document.getElementById('noiseCanvas');
        const ctx = canvas.getContext('2d');
        let noiseData = new Array(50).fill(0);

        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- FPS & Uptime ---
        let lastFrameTime = performance.now();
        let frameCount = 0;
        const fpsEl = document.getElementById('fpsCounter');

        function drawNoise() {
            // FPS Calculation
            const now = performance.now();
            frameCount++;
            if (now - lastFrameTime >= 1000) {
                if (fpsEl) fpsEl.innerText = frameCount;
                frameCount = 0;
                lastFrameTime = now;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00f0ff';

            // Shift data
            noiseData.shift();
            // If scanning, high noise, else low noise
            const volatility = isScanning ? 50 : 5;
            noiseData.push(Math.random() * volatility);

            const barWidth = canvas.width / noiseData.length;

            noiseData.forEach((val, i) => {
                const height = val;
                ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 1, height);
            });
            requestAnimationFrame(drawNoise);
        }

        drawNoise();

        // Uptime Counter
        const startTime = Date.now();
        const uptimeEl = document.getElementById('uptime');

        setInterval(() => {
            if (!uptimeEl) return;
            const diff = Date.now() - startTime;
            const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            uptimeEl.innerText = `${h}:${m}:${s}`;
        }, 1000);

        // --- Hex Dump Simulation ---
        function updateHex(riskLevel) {
            let hex = '';

            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 8; j++) {
                    let val = Math.floor(Math.random() * 255).toString(16).toUpperCase().padStart(2, '0');

                    if (isScanning && Math.random() > 0.8) {
                        if (riskLevel > 50) hex += `<span class="hex-danger">${val}</span>`;
                        else hex += `<span class="hex-highlight">${val}</span>`;
                    } else {
                        hex += `${val} `;
                    }
                }
                hex += '<br>';
            }

            hexDump.innerHTML = hex;
        }

        setInterval(() => {
            if (isScanning) updateHex(0);
        }, 100);

        // --- Logging System ---
        function log(msg, type = 'info') {
            const el = document.createElement('div');
            el.className = `log-item ${type}`;
            const ts = new Date().toLocaleTimeString('en-GB');
            el.innerHTML = `<span class="ts">${ts}</span><span>${msg}</span>`;
            logFeed.prepend(el); // Newest top
            if (logFeed.children.length > 20) logFeed.lastChild.remove();
        }

        // --- Helper: Format Bytes ---
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- Save Log Function ---
        function saveLog() {
            const logs = Array.from(document.querySelectorAll('.log-item')).map(el => {
                const ts = el.querySelector('.ts')?.innerText || '';
                const msg = el.innerText.replace(ts, '').trim();
                return `[${ts}] ${msg}`;
            }).join('\n');

            const blob = new Blob([logs], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `torrentguard_log_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // --- Socket Logic ---
        socket.on('connect', () => {
            document.getElementById('netStat').classList.add('on');
            document.getElementById('netStat').style.background = 'var(--c-accent-main)';
            log('UPLINK_ESTABLISHED', 'info');
        });

        socket.on('disconnect', () => {
            document.getElementById('netStat').classList.remove('on');
            document.getElementById('netStat').style.background = 'var(--c-accent-crit)';
            log('CARRIER_LOST', 'err');
        });

        socket.on('download_started', (data) => {
            log('DOWNLOAD_STARTED', 'info');
            document.getElementById('engineText').innerText = 'ENGINE_ACTIVE';
            document.getElementById('engineLight').style.boxShadow = '0 0 8px var(--c-accent-warn)';
            document.getElementById('engineLight').style.background = 'var(--c-accent-warn)';
        });

        // --- Upload Handling ---
        const fileInput = document.getElementById('fileInput');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            log(`PARSING_OBJECT: ${file.name}`, 'info');
            document.getElementById('dropZone').innerHTML = `<div style="color:var(--c-accent-main)">UPLOADING...</div>`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_URL}/api/upload-torrent`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    currentTorrentId = data.torrent.torrent_id;
                    totalPieces = data.torrent.total_pieces;

                    document.getElementById('metaName').innerText = data.torrent.name;
                    document.getElementById('metaSize').innerText = formatBytes(data.torrent.total_size);
                    document.getElementById('metaHash').innerText = currentTorrentId;
                    document.getElementById('btnScan').disabled = false;
                    document.getElementById('dropZone').innerHTML = `<div style="font-size:32px; color:var(--c-accent-main)">✔</div> <div>READY</div>`;

                    log('METADATA_LOCKED', 'info');
                } else {
                    log('UPLOAD_FAIL: ' + data.error, 'err');
                }
            } catch (err) {
                log('TRANSMISSION_ERROR', 'err');
            }
        });

        // --- Scan Logic ---
        async function startScan() {
            if (!currentTorrentId) return;
            isScanning = true;
            maxRisk = 0;
            document.getElementById('btnScan').innerText = 'SCAN_IN_PROGRESS...';

            // Build Grid
            gridPlane.innerHTML = '';
            // Cap visual pieces to 400 for DOM performance in this demo
            const displayPieces = Math.min(totalPieces, 400);

            for (let i = 0; i < displayPieces; i++) {
                const d = document.createElement('div');
                d.className = 'sector';
                d.id = `sector-${i}`;
                gridPlane.appendChild(d);
            }

            try {
                await fetch(`${API_URL}/api/start-download`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        torrent_id: currentTorrentId,
                        num_pieces: 25
                    })
                });
                log('SCAN_SEQUENCE_INITIATED', 'info');
            } catch (e) {
                isScanning = false;
                log('EXECUTION_FAIL', 'err');
            }
        }

        socket.on('piece_downloaded', (data) => {
            // Map actual piece index to our visual grid (modulo if larger)
            const visualIndex = data.piece_index % 400;

            const el = document.getElementById(`sector-${visualIndex}`);

            if (el) {
                if (data.scan_result.verdict === 'MALICIOUS') {
                    el.className = 'sector crit';
                    log(`THREAT_DETECT [IDX:${data.piece_index}]`, 'err');
                } else if (data.scan_result.verdict === 'SUSPICIOUS') {
                    el.className = 'sector warn';
                } else {
                    el.className = 'sector clean';
                }
            }

            // Update Gauge & Progress
            const risk = data.scan_result.risk_score;
            maxRisk = Math.max(maxRisk, risk);

            document.getElementById('riskNum').innerText = maxRisk.toFixed(1) + '%';
            document.getElementById('riskFill').style.width = maxRisk + '%';

            // Update MEM (Progress)
            if (data.progress !== undefined) {
                document.getElementById('memVal').innerText = Math.floor(data.progress).toString().padStart(2, '0');
            }

            if (maxRisk > 80) {
                document.getElementById('riskFill').style.backgroundColor = 'var(--c-accent-crit)';
                document.getElementById('riskFill').style.boxShadow = '0 0 15px var(--c-accent-crit)';
            } else if (maxRisk > 40) {
                document.getElementById('riskFill').style.backgroundColor = 'var(--c-accent-warn)';
                document.getElementById('riskFill').style.boxShadow = '0 0 15px var(--c-accent-warn)';
            }
        });

        socket.on('download_progress', (data) => {
            if (data.progress !== undefined) {
                document.getElementById('memVal').innerText = Math.floor(data.progress).toString().padStart(2, '0');
            }
        });

        socket.on('download_complete', (data) => {
            isScanning = false;
            document.getElementById('btnScan').innerText = 'SCAN_COMPLETE';

            // Reset Engine Status
            document.getElementById('engineText').innerText = 'ENGINE_IDLE';
            document.getElementById('engineLight').style.background = 'var(--c-accent-main)';
            document.getElementById('engineLight').style.boxShadow = '0 0 8px var(--c-accent-main)';

            const overlay = document.getElementById('resultOverlay');
            const title = document.getElementById('reportTitle');
            const sub = document.getElementById('reportSub');

            if (data.quarantined) {
                title.innerText = 'CONTAINMENT_ACTIVE';
                title.style.color = 'var(--c-accent-crit)';

                sub.innerHTML = `Subject contains high-confidence viral signatures.<br>Automated quarantine protocols enforced.<br><br>RISK_FACTOR: <span style="color:var(--c-accent-crit)">${data.max_risk_score.toFixed(1)}%</span>`;
            } else if (data.verdict === 'MALICIOUS') {
                title.innerText = 'THREAT_IDENTIFIED';
                title.style.color = 'var(--c-accent-crit)';
                sub.innerHTML = `Malicious patterns detected. Manual intervention recommended.`;
            } else {
                title.innerText = 'SPECIMEN_CLEAN';
                title.style.color = 'var(--c-accent-main)';
                sub.innerHTML = `No pathogenic code structures detected.<br>File release authorized.`;
            }

            overlay.classList.add('visible');
        });
    </script>
</body>

</html>